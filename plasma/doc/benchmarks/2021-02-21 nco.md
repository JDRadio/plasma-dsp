# New test
## Description
I have modified the test a bit, where I now test common values used in SDRs.

## Results
```
2021-02-21T09:55:15-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.36, 0.40, 0.35
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------
Benchmark                          Time             CPU   Iterations
--------------------------------------------------------------------
nco_up<float>/1024             28766 ns        28761 ns        24339
nco_up<float>/4096            116299 ns       116278 ns         6078
nco_up<float>/32768           920083 ns       919917 ns          758
nco_up<float>/262144         7396784 ns      7395356 ns           93
nco_up<float>/1024000       28801596 ns     28795022 ns           24
nco_up<float>/4096000      115506281 ns    115479732 ns            6
nco_up<float>/16000000     449877325 ns    449767884 ns            2
nco_up<float>/27000000     758913351 ns    758721863 ns            1
nco_up<float>/35000000     985470723 ns    985235268 ns            1
nco_up<float>/50000000    1427462288 ns   1427158026 ns            1
nco_down<float>/1024           29286 ns        29280 ns        23954
nco_down<float>/4096          117465 ns       117441 ns         5998
nco_down<float>/32768         937075 ns       936903 ns          751
nco_down<float>/262144       7489766 ns      7488155 ns           93
nco_down<float>/1024000     29165773 ns     29161010 ns           24
nco_down<float>/4096000    117208177 ns    117176888 ns            6
nco_down<float>/16000000   460058871 ns    459946322 ns            2
nco_down<float>/27000000   776143808 ns    775978691 ns            1
nco_down<float>/35000000  1004929854 ns   1004676703 ns            1
nco_down<float>/50000000  1432806869 ns   1432443607 ns            1
nco_up<double>/1024            37318 ns        37311 ns        18675
nco_up<double>/4096           149208 ns       149180 ns         4696
nco_up<double>/32768         1201791 ns      1201551 ns          586
nco_up<double>/262144        9588762 ns      9586893 ns           73
nco_up<double>/1024000      37418452 ns     37410087 ns           19
nco_up<double>/4096000     149259709 ns    149225540 ns            5
nco_up<double>/16000000    584357062 ns    584199505 ns            1
nco_up<double>/27000000    984824927 ns    984587102 ns            1
nco_up<double>/35000000   1279257848 ns   1278955889 ns            1
nco_up<double>/50000000   1824613267 ns   1824184416 ns            1
nco_down<double>/1024          37516 ns        37509 ns        18677
nco_down<double>/4096         150529 ns       150501 ns         4654
nco_down<double>/32768       1207470 ns      1207161 ns          584
nco_down<double>/262144      9607830 ns      9605956 ns           72
nco_down<double>/1024000    37691980 ns     37682045 ns           19
nco_down<double>/4096000   149906029 ns    149871742 ns            5
nco_down<double>/16000000  584825694 ns    584498993 ns            1
nco_down<double>/27000000  989552186 ns    987626282 ns            1
nco_down<double>/35000000 1287243660 ns   1284727411 ns            1
nco_down<double>/50000000 1812115170 ns   1811670568 ns            1
```

## Analysis
This will be our new baseline. I first test some common buffer sizes: 1024, 4096, 32768, 262144.
I then test some common SDR sampling rates: 1.024M, 4.096M, 16M, 50M.
The last two are probably less common, but are still very possible in the realm of SDRs and will give us a picture of
the capabilities.

In this baseline, the break-even point for processing would be around a sampling rate of 35M for floats and 27M for doubles, which is why I have included them as well.


# Lookup table
## Description
The only obvious improvement left is to use a lookup table instead of `std::cos` and `std::sin`.
A benchmark of the method will be done before actually calculating the right values, only on `nco_up` as usual.

## Results
```
2021-02-21T10:11:15-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.22, 0.33, 0.31
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------
Benchmark                          Time             CPU   Iterations
--------------------------------------------------------------------
nco_up<float>/1024             26003 ns        25995 ns        27482
nco_up<float>/4096            103474 ns       103448 ns         6630
nco_up<float>/32768           815162 ns       815006 ns          857
nco_up<float>/262144         6526992 ns      6525671 ns          107
nco_up<float>/1024000       25656483 ns     25650311 ns           27
nco_up<float>/4096000      102158174 ns    102131498 ns            7
nco_up<float>/16000000     397209130 ns    397112466 ns            2
nco_up<float>/27000000     671464085 ns    671279573 ns            1
nco_up<float>/35000000     869368127 ns    869130279 ns            1
nco_up<float>/50000000    1242508747 ns   1242264726 ns            1
nco_down<float>/1024           29300 ns        29295 ns        24089
nco_down<float>/4096          116619 ns       116598 ns         6010
nco_down<float>/32768         935992 ns       935845 ns          756
nco_down<float>/262144       7471506 ns      7469835 ns           94
nco_down<float>/1024000     29052999 ns     29045716 ns           24
nco_down<float>/4096000    116499231 ns    116471922 ns            6
nco_down<float>/16000000   455058624 ns    454932272 ns            2
nco_down<float>/27000000   766956634 ns    766796570 ns            1
nco_down<float>/35000000   995606124 ns    995387025 ns            1
nco_down<float>/50000000  1420213723 ns   1419909929 ns            1
nco_up<double>/1024            25653 ns        25649 ns        27301
nco_up<double>/4096           102775 ns       102755 ns         6838
nco_up<double>/32768          820835 ns       820649 ns          858
nco_up<double>/262144        6561388 ns      6560246 ns          106
nco_up<double>/1024000      25611209 ns     25604434 ns           27
nco_up<double>/4096000     102543974 ns    102513154 ns            7
nco_up<double>/16000000    401964692 ns    401847246 ns            2
nco_up<double>/27000000    676040490 ns    675887359 ns            1
nco_up<double>/35000000    881790141 ns    881545318 ns            1
nco_up<double>/50000000   1253936821 ns   1253628628 ns            1
nco_down<double>/1024          37408 ns        37402 ns        18813
nco_down<double>/4096         149119 ns       149096 ns         4702
nco_down<double>/32768       1193258 ns      1192771 ns          588
nco_down<double>/262144      9563627 ns      9561516 ns           73
nco_down<double>/1024000    37334100 ns     37318215 ns           19
nco_down<double>/4096000   149551061 ns    149513713 ns            5
nco_down<double>/16000000  582985231 ns    582699789 ns            1
nco_down<double>/27000000  982854830 ns    982623590 ns            1
nco_down<double>/35000000 1275090384 ns   1274642007 ns            1
nco_down<double>/50000000 1831685845 ns   1831126163 ns            1
```

## Analysis
There is indeed a small performance gain to be had. Note that this is a very crude implementation with only 1024 values in the lookup table, giving us an angular resolution of about 0.000977, or to put this in context, this is an error of about 98 Hz over 100 kHz.


# Bigger table
## Description
To compensate for loss of precision, let's use a bigger lookup table: 4096 values.

## Results
```
2021-02-21T11:18:39-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.24, 0.28, 0.29
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------
Benchmark                          Time             CPU   Iterations
--------------------------------------------------------------------
nco_up<float>/1024             25218 ns        25213 ns        27619
nco_up<float>/4096            100581 ns       100565 ns         6988
nco_up<float>/32768           811928 ns       811770 ns          863
nco_up<float>/262144         6452144 ns      6451019 ns          109
nco_up<float>/1024000       25280750 ns     25275153 ns           28
nco_up<float>/4096000      101720304 ns    101689804 ns            7
nco_up<float>/16000000     390292245 ns    390197416 ns            2
nco_up<float>/27000000     662216652 ns    662033786 ns            1
nco_up<float>/35000000     864552850 ns    864305852 ns            1
nco_up<float>/50000000    1215791304 ns   1215506684 ns            1
nco_down<float>/1024           36237 ns        36229 ns        19533
nco_down<float>/4096          145615 ns       145576 ns         4769
nco_down<float>/32768        1158959 ns      1158705 ns          595
nco_down<float>/262144       9125966 ns      9123852 ns           76
nco_down<float>/1024000     35491407 ns     35484054 ns           19
nco_down<float>/4096000    142671778 ns    142641243 ns            5
nco_down<float>/16000000   555474668 ns    555346783 ns            1
nco_down<float>/27000000   954604336 ns    954376344 ns            1
nco_down<float>/35000000  1219639442 ns   1219358465 ns            1
nco_down<float>/50000000  1732813344 ns   1732449911 ns            1
nco_up<double>/1024            25054 ns        25048 ns        27925
nco_up<double>/4096           100303 ns       100284 ns         6988
nco_up<double>/32768          804149 ns       803956 ns          872
nco_up<double>/262144        6449812 ns      6448077 ns          108
nco_up<double>/1024000      25130599 ns     25122961 ns           28
nco_up<double>/4096000     101022264 ns    100992079 ns            7
nco_up<double>/16000000    395408650 ns    395299429 ns            2
nco_up<double>/27000000    676290017 ns    674719465 ns            1
nco_up<double>/35000000    873822067 ns    870909741 ns            1
nco_up<double>/50000000   1238507623 ns   1238173095 ns            1
nco_down<double>/1024          37011 ns        37004 ns        18868
nco_down<double>/4096         148229 ns       148200 ns         4726
nco_down<double>/32768       1193413 ns      1193151 ns          578
nco_down<double>/262144      9509047 ns      9507012 ns           74
nco_down<double>/1024000    37271822 ns     37261683 ns           19
nco_down<double>/4096000   148621642 ns    148582591 ns            5
nco_down<double>/16000000  578215494 ns    578062214 ns            1
nco_down<double>/27000000  979670071 ns    979445506 ns            1
nco_down<double>/35000000 1266422112 ns   1266102295 ns            1
nco_down<double>/50000000 1817486748 ns   1817007880 ns            1
```

## Analysis
As expected, the lookup time did not change by using a larger lookup table. It only uses up more memory, which is not a concern for this library.

We can also notice the timing for `float` vs `double` is now very similar. It turns out the `std::cos` and `std::sin` functions operate slower for `double`s than for `float`s, but the rest of the operations are very similar.


# Template specialization
## Description
Replacing the NCO's two possible modes (with lookup and without lookup) by specialized templates, let's see if anything changed. As usual, `nco_up` is using the lookup table, and `nco_down` is not.

## Results
```
2021-02-21T16:46:42-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.54, 0.48, 0.37
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------
Benchmark                          Time             CPU   Iterations
--------------------------------------------------------------------
nco_up<float>/1024             25828 ns        25747 ns        27615
nco_up<float>/4096            103110 ns       102795 ns         6832
nco_up<float>/32768           826599 ns       824581 ns          854
nco_up<float>/262144         6580303 ns      6557617 ns          105
nco_up<float>/1024000       25886236 ns     25784953 ns           27
nco_up<float>/4096000      103092152 ns    102764108 ns            7
nco_up<float>/16000000     412527622 ns    409981345 ns            2
nco_up<float>/27000000     677790619 ns    677559129 ns            1
nco_up<float>/35000000     866569729 ns    866305274 ns            1
nco_up<float>/50000000    1244571462 ns   1244180290 ns            1
nco_down<float>/1024           35805 ns        35797 ns        19534
nco_down<float>/4096          142483 ns       142455 ns         4929
nco_down<float>/32768        1142141 ns      1141929 ns          616
nco_down<float>/262144       9303280 ns      9301145 ns           74
nco_down<float>/1024000     35795626 ns     35787630 ns           20
nco_down<float>/4096000    143877673 ns    143844486 ns            5
nco_down<float>/16000000   564181644 ns    564032011 ns            1
nco_down<float>/27000000   955364663 ns    955100498 ns            1
nco_down<float>/35000000  1224199568 ns   1223877985 ns            1
nco_down<float>/50000000  1766358059 ns   1765890433 ns            1
nco_up<double>/1024            26749 ns        26741 ns        25774
nco_up<double>/4096           102125 ns       102099 ns         6661
nco_up<double>/32768          806995 ns       806787 ns          874
nco_up<double>/262144        6411703 ns      6409788 ns          109
nco_up<double>/1024000      25509620 ns     25496943 ns           28
nco_up<double>/4096000     101888157 ns    101843799 ns            7
nco_up<double>/16000000    395030256 ns    394897527 ns            2
nco_up<double>/27000000    681145841 ns    678485751 ns            1
nco_up<double>/35000000    871745956 ns    871465605 ns            1
nco_up<double>/50000000   1240494567 ns   1240152110 ns            1
nco_down<double>/1024          36859 ns        36853 ns        19026
nco_down<double>/4096         147728 ns       147700 ns         4768
nco_down<double>/32768       1179080 ns      1178872 ns          597
nco_down<double>/262144      9412362 ns      9410594 ns           74
nco_down<double>/1024000    37145272 ns     37135843 ns           19
nco_down<double>/4096000   147916643 ns    147876514 ns            5
nco_down<double>/16000000  573888163 ns    573763292 ns            1
nco_down<double>/27000000  970512217 ns    970282931 ns            1
nco_down<double>/35000000 1262681163 ns   1262404781 ns            1
nco_down<double>/50000000 1800670008 ns   1800229370 ns            1
```

## Analysis
The values are pretty much the same, meaning the conversion did not impact anything in terms of performance.


# Complex samples
## Description
Let add complex samples into the mix. Since there are a lot of results to display, let's only keep the `nco_up` branch, using the lookup table.

## Results
```
2021-02-21T17:01:18-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 1.25, 0.83, 0.54
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   25210 ns        25204 ns        27339
nco_up<float>/4096                  100728 ns       100708 ns         6879
nco_up<float>/32768                 810920 ns       810737 ns          871
nco_up<float>/262144               6392368 ns      6391157 ns          109
nco_up<float>/1024000             25102588 ns     25090940 ns           28
nco_up<float>/4096000            100431011 ns    100410972 ns            7
nco_up<float>/16000000           397153143 ns    396965952 ns            2
nco_up<float>/27000000           659738576 ns    659573724 ns            1
nco_up<float>/35000000           855298758 ns    855128825 ns            1
nco_up<float>/50000000          1221149211 ns   1220899386 ns            1
nco_up_complex<float>/1024           44469 ns        44462 ns        15731
nco_up_complex<float>/4096          177979 ns       177951 ns         3928
nco_up_complex<float>/32768        1424862 ns      1424605 ns          489
nco_up_complex<float>/262144      11376652 ns     11374532 ns           62
nco_up_complex<float>/1024000     44410339 ns     44401489 ns           16
nco_up_complex<float>/4096000    177760088 ns    177724217 ns            4
nco_up_complex<float>/16000000   695468236 ns    695324783 ns            1
nco_up_complex<float>/27000000  1171257150 ns   1171005468 ns            1
nco_up_complex<float>/35000000  1520692245 ns   1520377286 ns            1
nco_up_complex<float>/50000000  2166086525 ns   2165629765 ns            1
nco_up<double>/1024                  25332 ns        25327 ns        27822
nco_up<double>/4096                 100872 ns       100854 ns         6840
nco_up<double>/32768                810311 ns       810138 ns          854
nco_up<double>/262144              6489663 ns      6488358 ns          108
nco_up<double>/1024000            25313065 ns     25306552 ns           28
nco_up<double>/4096000           101195866 ns    101170551 ns            7
nco_up<double>/16000000          395693767 ns    395582247 ns            2
nco_up<double>/27000000          665245506 ns    665065446 ns            1
nco_up<double>/35000000          865721460 ns    865511944 ns            1
nco_up<double>/50000000         1234211044 ns   1233886638 ns            1
nco_up_complex<double>/1024          32841 ns        32835 ns        21259
nco_up_complex<double>/4096         131363 ns       131342 ns         5350
nco_up_complex<double>/32768       1054112 ns      1053911 ns          667
nco_up_complex<double>/262144      8440193 ns      8438325 ns           83
nco_up_complex<double>/1024000    33095728 ns     33088434 ns           21
nco_up_complex<double>/4096000   131855485 ns    131822664 ns            5
nco_up_complex<double>/16000000  514463661 ns    514364062 ns            1
nco_up_complex<double>/27000000  871946869 ns    871737144 ns            1
nco_up_complex<double>/35000000 1125904715 ns   1125611656 ns            1
nco_up_complex<double>/50000000 1604236608 ns   1603867074 ns            1
```

## Analysis
For a strange reason unknown to me at this time, `std::complex<double>` is faster than `std::complex<float>`. Overall, using `std::complex` is slower than using interleaved real/imaginary components, most likely due to the constructor.


# Skip `std::complex` constructor
## Description
Let's try to avoid calling the constructor when we build our phasor.

## Results
```
2021-02-21T17:07:21-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.34, 0.55, 0.51
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   25117 ns        25111 ns        28162
nco_up<float>/4096                  100608 ns       100584 ns         7006
nco_up<float>/32768                 804144 ns       803937 ns          878
nco_up<float>/262144               6426512 ns      6424680 ns          108
nco_up<float>/1024000             24964631 ns     24958850 ns           28
nco_up<float>/4096000            101204168 ns    101148973 ns            6
nco_up<float>/16000000           390577669 ns    390498601 ns            2
nco_up<float>/27000000           657216887 ns    657077074 ns            1
nco_up<float>/35000000           863650186 ns    863474657 ns            1
nco_up<float>/50000000          1259101185 ns   1245718126 ns            1
nco_up_complex<float>/1024           32116 ns        31760 ns        21870
nco_up_complex<float>/4096          128240 ns       126985 ns         5540
nco_up_complex<float>/32768        1027841 ns      1017659 ns          686
nco_up_complex<float>/262144       8203886 ns      8185205 ns           84
nco_up_complex<float>/1024000     32241387 ns     32169109 ns           22
nco_up_complex<float>/4096000    128945674 ns    128654016 ns            5
nco_up_complex<float>/16000000   506866820 ns    505017805 ns            1
nco_up_complex<float>/27000000   851915870 ns    849830768 ns            1
nco_up_complex<float>/35000000  1105991590 ns   1099385095 ns            1
nco_up_complex<float>/50000000  1539273046 ns   1538939388 ns            1
nco_up<double>/1024                  25259 ns        25253 ns        27657
nco_up<double>/4096                 101053 ns       101034 ns         6913
nco_up<double>/32768                812144 ns       811996 ns          867
nco_up<double>/262144              6500876 ns      6498760 ns          108
nco_up<double>/1024000            25310613 ns     25301813 ns           28
nco_up<double>/4096000           100979045 ns    100954537 ns            7
nco_up<double>/16000000          395846570 ns    395745498 ns            2
nco_up<double>/27000000          667895533 ns    667708054 ns            1
nco_up<double>/35000000          865216976 ns    864977892 ns            1
nco_up<double>/50000000         1250942975 ns   1250446997 ns            1
nco_up_complex<double>/1024          29069 ns        29063 ns        24436
nco_up_complex<double>/4096         115789 ns       115770 ns         6085
nco_up_complex<double>/32768        924577 ns       924424 ns          759
nco_up_complex<double>/262144      7424336 ns      7422590 ns           95
nco_up_complex<double>/1024000    29030840 ns     29023077 ns           24
nco_up_complex<double>/4096000   118439926 ns    118406310 ns            6
nco_up_complex<double>/16000000  457317566 ns    457203894 ns            2
nco_up_complex<double>/27000000  777075981 ns    776881985 ns            1
nco_up_complex<double>/35000000  996386068 ns    996132249 ns            1
nco_up_complex<double>/50000000 1438818913 ns   1438448032 ns            1
```

## Analysis
There are definitely some improvements. The `std::complex<double>` is almost as fast as the interleaved `double`s. The low performance of `std::complex<float>` is really troubling me. It just goes to show that all those other DSP libraries out there making use of `std::complex<float>` are slower just because of it.


# Lookup improvements
## Description
The lookup operation uses a modulo, which I believe is much slower than an `if` block.

## Results
```
2021-02-21T17:55:22-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.79, 0.49, 0.40
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   28273 ns        28267 ns        25015
nco_up<float>/4096                  112905 ns       112881 ns         6192
nco_up<float>/32768                 894638 ns       894443 ns          784
nco_up<float>/262144               7156963 ns      7154960 ns           98
nco_up<float>/1024000             27919123 ns     27912453 ns           25
nco_up<float>/4096000            111790511 ns    111760942 ns            6
nco_up<float>/16000000           442927231 ns    442809626 ns            2
nco_up<float>/27000000           751973976 ns    751775857 ns            1
nco_up<float>/35000000           981104041 ns    980884512 ns            1
nco_up<float>/50000000          1402542275 ns   1402064704 ns            1
nco_up_complex<float>/1024           32419 ns        32414 ns        20958
nco_up_complex<float>/4096          138997 ns       138972 ns         4714
nco_up_complex<float>/32768        1019812 ns      1019574 ns          672
nco_up_complex<float>/262144       8246497 ns      8242606 ns           86
nco_up_complex<float>/1024000     32379284 ns     32371463 ns           22
nco_up_complex<float>/4096000    132083872 ns    132022788 ns            5
nco_up_complex<float>/16000000   537925967 ns    537819516 ns            1
nco_up_complex<float>/27000000   888092182 ns    887719122 ns            1
nco_up_complex<float>/35000000  1174052010 ns   1173777113 ns            1
nco_up_complex<float>/50000000  1616974045 ns   1616608661 ns            1
nco_up<double>/1024                  27971 ns        27966 ns        25176
nco_up<double>/4096                 111517 ns       111496 ns         6281
nco_up<double>/32768                891405 ns       891041 ns          779
nco_up<double>/262144              7129652 ns      7128062 ns           98
nco_up<double>/1024000            27995839 ns     27981336 ns           25
nco_up<double>/4096000           111384271 ns    111353338 ns            6
nco_up<double>/16000000          435624047 ns    435429356 ns            2
nco_up<double>/27000000          739661797 ns    739432307 ns            1
nco_up<double>/35000000          954832715 ns    954552660 ns            1
nco_up<double>/50000000         1363563030 ns   1363057537 ns            1
nco_up_complex<double>/1024          34199 ns        34185 ns        20490
nco_up_complex<double>/4096         136487 ns       136460 ns         5142
nco_up_complex<double>/32768       1089415 ns      1089214 ns          641
nco_up_complex<double>/262144      8653193 ns      8649503 ns           80
nco_up_complex<double>/1024000    33935656 ns     33927009 ns           21
nco_up_complex<double>/4096000   135609764 ns    135544357 ns            5
nco_up_complex<double>/16000000  530770728 ns    530639231 ns            1
nco_up_complex<double>/27000000  896960131 ns    896547150 ns            1
nco_up_complex<double>/35000000 1166107961 ns   1165642107 ns            1
nco_up_complex<double>/50000000 1665398246 ns   1664828663 ns            1
```

## Analysis
Guess I was wrong. The extra branching introduced seems to slow down the operation. Let's revert!


# Inlining
## Description
Moving the code inline rather than through a function call might speed things up. Let's move `cos` and `sin` lookups inline.

## Results
```
2021-02-21T18:07:36-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.98, 0.82, 0.66
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   22698 ns        22694 ns        30891
nco_up<float>/4096                   91233 ns        91196 ns         7697
nco_up<float>/32768                 727660 ns       727543 ns          963
nco_up<float>/262144               5839953 ns      5838857 ns          120
nco_up<float>/1024000             22847443 ns     22842110 ns           31
nco_up<float>/4096000             91279380 ns     91257348 ns            8
nco_up<float>/16000000           355589861 ns    355512158 ns            2
nco_up<float>/27000000           599385577 ns    599265072 ns            1
nco_up<float>/35000000           779017798 ns    778843903 ns            1
nco_up<float>/50000000          1116334844 ns   1115912559 ns            1
nco_up_complex<float>/1024           25343 ns        25338 ns        27635
nco_up_complex<float>/4096          101210 ns       101167 ns         6899
nco_up_complex<float>/32768         811560 ns       811401 ns          872
nco_up_complex<float>/262144       6499686 ns      6498269 ns           99
nco_up_complex<float>/1024000     25326642 ns     25321112 ns           28
nco_up_complex<float>/4096000    101103499 ns    101082036 ns            7
nco_up_complex<float>/16000000   396537878 ns    396457876 ns            2
nco_up_complex<float>/27000000   668550974 ns    668232168 ns            1
nco_up_complex<float>/35000000   868543723 ns    868343190 ns            1
nco_up_complex<float>/50000000  1247205378 ns   1246720453 ns            1
nco_up<double>/1024                  22987 ns        22979 ns        30407
nco_up<double>/4096                  91978 ns        91961 ns         7675
nco_up<double>/32768                730757 ns       730610 ns          964
nco_up<double>/262144              5857910 ns      5855198 ns          119
nco_up<double>/1024000            22926956 ns     22920465 ns           31
nco_up<double>/4096000            91700948 ns     91653627 ns            8
nco_up<double>/16000000          357625230 ns    357519482 ns            2
nco_up<double>/27000000          603738066 ns    603561485 ns            1
nco_up<double>/35000000          783807801 ns    783580500 ns            1
nco_up<double>/50000000         1114706218 ns   1114388887 ns            1
nco_up_complex<double>/1024          26122 ns        26111 ns        26948
nco_up_complex<double>/4096         104993 ns       104975 ns         6753
nco_up_complex<double>/32768        836439 ns       836117 ns          846
nco_up_complex<double>/262144      6686736 ns      6685395 ns          105
nco_up_complex<double>/1024000    26101545 ns     26094338 ns           27
nco_up_complex<double>/4096000   103980308 ns    103947365 ns            7
nco_up_complex<double>/16000000  406525028 ns    406435325 ns            2
nco_up_complex<double>/27000000  685145571 ns    684984850 ns            1
nco_up_complex<double>/35000000  891502145 ns    891253783 ns            1
nco_up_complex<double>/50000000 1272120005 ns   1271804116 ns            1
```

## Analysis
It turns out there is some performance gain to be had. The function itself is a one line `return` statement, but it seems the compiler does not optimize it as an `inline` function.


# Inlining II
## Description
It seems the compiler does not want to inline my function calls, so let's skip the function altogether. It brings in code duplication, but I'm all for those performance gains. This time it's the call to `step` that will get inlined.

## Results
```
2021-02-21T18:14:47-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.87, 0.55, 0.58
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   21632 ns        21627 ns        31691
nco_up<float>/4096                   86992 ns        86975 ns         8081
nco_up<float>/32768                 698525 ns       698374 ns         1005
nco_up<float>/262144               5562832 ns      5561613 ns          122
nco_up<float>/1024000             21730874 ns     21725203 ns           32
nco_up<float>/4096000             86980673 ns     86960374 ns            8
nco_up<float>/16000000           336722073 ns    336638510 ns            2
nco_up<float>/27000000           570354492 ns    570214791 ns            1
nco_up<float>/35000000           738131235 ns    737938473 ns            1
nco_up<float>/50000000          1062715980 ns   1062450072 ns            1
nco_up_complex<float>/1024           24400 ns        24395 ns        28657
nco_up_complex<float>/4096           97925 ns        97904 ns         7113
nco_up_complex<float>/32768         778095 ns       777938 ns          888
nco_up_complex<float>/262144       6252966 ns      6251592 ns          113
nco_up_complex<float>/1024000     24466109 ns     24459916 ns           29
nco_up_complex<float>/4096000     97572946 ns     97548924 ns            7
nco_up_complex<float>/16000000   382624492 ns    382536214 ns            2
nco_up_complex<float>/27000000   643573943 ns    643426473 ns            1
nco_up_complex<float>/35000000   835366811 ns    835171442 ns            1
nco_up_complex<float>/50000000  1198892897 ns   1198559650 ns            1
nco_up<double>/1024                  21813 ns        21808 ns        31834
nco_up<double>/4096                  87272 ns        87254 ns         8086
nco_up<double>/32768                705992 ns       705821 ns         1001
nco_up<double>/262144              5793826 ns      5792123 ns          123
nco_up<double>/1024000            21835141 ns     21827622 ns           32
nco_up<double>/4096000            87536282 ns     87506411 ns            8
nco_up<double>/16000000          347597832 ns    347455153 ns            2
nco_up<double>/27000000          576219223 ns    575995438 ns            1
nco_up<double>/35000000          741783592 ns    741564949 ns            1
nco_up<double>/50000000         1064568874 ns   1064231287 ns            1
nco_up_complex<double>/1024          24609 ns        24606 ns        28449
nco_up_complex<double>/4096          98516 ns        98499 ns         7152
nco_up_complex<double>/32768        787756 ns       787594 ns          890
nco_up_complex<double>/262144      6304350 ns      6303054 ns          111
nco_up_complex<double>/1024000    24718796 ns     24711533 ns           28
nco_up_complex<double>/4096000    99991589 ns     99961780 ns            7
nco_up_complex<double>/16000000  396136231 ns    395972023 ns            2
nco_up_complex<double>/27000000  666764050 ns    666546415 ns            1
nco_up_complex<double>/35000000  849159304 ns    848858625 ns            1
nco_up_complex<double>/50000000 1215010535 ns   1214573405 ns            1
```

## Analysis
Small performance gain, but a gain nonetheless.


# Inlining III
## Description
When looping over the `std::vector`, a function is called each time to process the sample. Let's inline that too.

## Results
```
2021-02-21T18:21:14-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.45, 0.53, 0.56
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   22648 ns        22643 ns        31180
nco_up<float>/4096                   90937 ns        90918 ns         7737
nco_up<float>/32768                 722396 ns       722240 ns          940
nco_up<float>/262144               5773843 ns      5772390 ns          121
nco_up<float>/1024000             22605282 ns     22598002 ns           31
nco_up<float>/4096000             90664985 ns     90640176 ns            8
nco_up<float>/16000000           354949819 ns    354861686 ns            2
nco_up<float>/27000000           595723479 ns    595587535 ns            1
nco_up<float>/35000000           775350581 ns    775161783 ns            1
nco_up<float>/50000000          1106004342 ns   1105702176 ns            1
nco_up_complex<float>/1024           27944 ns        27939 ns        25155
nco_up_complex<float>/4096          112088 ns       112066 ns         6245
nco_up_complex<float>/32768         890879 ns       890675 ns          788
nco_up_complex<float>/262144       7356076 ns      7354493 ns           98
nco_up_complex<float>/1024000     27865939 ns     27858204 ns           25
nco_up_complex<float>/4096000    111694763 ns    111667173 ns            6
nco_up_complex<float>/16000000   438298733 ns    438193772 ns            2
nco_up_complex<float>/27000000   737777503 ns    737571776 ns            1
nco_up_complex<float>/35000000   972078780 ns    969001514 ns            1
nco_up_complex<float>/50000000  1392018278 ns   1387915073 ns            1
nco_up<double>/1024                  23210 ns        23144 ns        30378
nco_up<double>/4096                  92404 ns        92199 ns         7630
nco_up<double>/32768                738485 ns       738037 ns          946
nco_up<double>/262144              5929401 ns      5919750 ns          118
nco_up<double>/1024000            23290331 ns     23240176 ns           30
nco_up<double>/4096000            92708674 ns     92435443 ns            8
nco_up<double>/16000000          361273150 ns    360655290 ns            2
nco_up<double>/27000000          607925782 ns    607472992 ns            1
nco_up<double>/35000000          792584280 ns    791312908 ns            1
nco_up<double>/50000000         1135685173 ns   1133207762 ns            1
nco_up_complex<double>/1024          28854 ns        28816 ns        24405
nco_up_complex<double>/4096         114447 ns       114421 ns         6226
nco_up_complex<double>/32768        924853 ns       924626 ns          729
nco_up_complex<double>/262144      7383533 ns      7381520 ns           95
nco_up_complex<double>/1024000    28629862 ns     28622176 ns           25
nco_up_complex<double>/4096000   116584828 ns    116549794 ns            6
nco_up_complex<double>/16000000  450315666 ns    450101468 ns            2
nco_up_complex<double>/27000000  751103935 ns    750900764 ns            1
nco_up_complex<double>/35000000  982577318 ns    982133059 ns            1
nco_up_complex<double>/50000000 1393765306 ns   1393205680 ns            1
```

## Analysis
It seems we have lost performance. This might be due to the compiler no longer being able to perform loop unrolling. Let's revert.


# Repeated calls
## Description
Repeated function calls which are expected to always return the same value could be avoided by using a variable instead.

## Results
```
2021-02-21T18:27:27-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.34, 0.43, 0.51
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   20168 ns        20164 ns        34943
nco_up<float>/4096                   80606 ns        80587 ns         8695
nco_up<float>/32768                 644990 ns       644823 ns         1091
nco_up<float>/262144               5203230 ns      5201851 ns          135
nco_up<float>/1024000             20238298 ns     20232551 ns           35
nco_up<float>/4096000             80860708 ns     80836591 ns            9
nco_up<float>/16000000           315031996 ns    314944218 ns            2
nco_up<float>/27000000           532269163 ns    532136135 ns            1
nco_up<float>/35000000           714760483 ns    714462657 ns            1
nco_up<float>/50000000          1002220422 ns   1001899750 ns            1
nco_up_complex<float>/1024           23155 ns        23149 ns        30612
nco_up_complex<float>/4096           92250 ns        92228 ns         7644
nco_up_complex<float>/32768         743981 ns       743761 ns          947
nco_up_complex<float>/262144       5968208 ns      5966765 ns          117
nco_up_complex<float>/1024000     23071785 ns     23065130 ns           30
nco_up_complex<float>/4096000     92273573 ns     92250935 ns            8
nco_up_complex<float>/16000000   364344107 ns    364230236 ns            2
nco_up_complex<float>/27000000   618133585 ns    617934664 ns            1
nco_up_complex<float>/35000000   790127935 ns    789898188 ns            1
nco_up_complex<float>/50000000  1126385226 ns   1126100720 ns            1
nco_up<double>/1024                  20559 ns        20554 ns        34393
nco_up<double>/4096                  80763 ns        80745 ns         8679
nco_up<double>/32768                651678 ns       651516 ns         1074
nco_up<double>/262144              5182019 ns      5180731 ns          136
nco_up<double>/1024000            20254796 ns     20247232 ns           35
nco_up<double>/4096000            81477473 ns     81444401 ns            9
nco_up<double>/16000000          314406454 ns    314280799 ns            2
nco_up<double>/27000000          532556235 ns    532376850 ns            1
nco_up<double>/35000000          688588714 ns    688334415 ns            1
nco_up<double>/50000000          984756473 ns    984394902 ns            1
nco_up_complex<double>/1024          23419 ns        23413 ns        30025
nco_up_complex<double>/4096          96067 ns        96042 ns         7500
nco_up_complex<double>/32768        768005 ns       767800 ns          934
nco_up_complex<double>/262144      6051352 ns      6049475 ns          115
nco_up_complex<double>/1024000    23472239 ns     23464268 ns           29
nco_up_complex<double>/4096000    93735905 ns     93705643 ns            8
nco_up_complex<double>/16000000  367773952 ns    367634635 ns            2
nco_up_complex<double>/27000000  627237983 ns    627013898 ns            1
nco_up_complex<double>/35000000  799174815 ns    798916370 ns            1
nco_up_complex<double>/50000000 1143987369 ns   1143608755 ns            1
```

## Analysis
There is definitely some improvement seen. Let's be even more aggressive in reducing function calls by using variables instead.


# Repeated calls II
## Description
Let's be even more aggressive.

## Results
```
2021-02-21T18:31:21-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.30, 0.47, 0.52
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   14815 ns        14812 ns        48013
nco_up<float>/4096                   59295 ns        59282 ns        11898
nco_up<float>/32768                 472113 ns       472003 ns         1483
nco_up<float>/262144               3822846 ns      3821786 ns          184
nco_up<float>/1024000             15172190 ns     15167874 ns           47
nco_up<float>/4096000             59500494 ns     59485569 ns           12
nco_up<float>/16000000           231150884 ns    231096224 ns            3
nco_up<float>/27000000           391876420 ns    391782403 ns            2
nco_up<float>/35000000           504314450 ns    504199920 ns            1
nco_up<float>/50000000           722134580 ns    721958194 ns            1
nco_up_complex<float>/1024           18425 ns        18422 ns        38109
nco_up_complex<float>/4096           73622 ns        73610 ns         9400
nco_up_complex<float>/32768         589199 ns       589099 ns         1192
nco_up_complex<float>/262144       4716148 ns      4715246 ns          148
nco_up_complex<float>/1024000     18721360 ns     18717780 ns           38
nco_up_complex<float>/4096000     75756962 ns     75736638 ns           10
nco_up_complex<float>/16000000   296194453 ns    296129402 ns            2
nco_up_complex<float>/27000000   494958179 ns    494848402 ns            2
nco_up_complex<float>/35000000   642734515 ns    642556243 ns            1
nco_up_complex<float>/50000000   938019427 ns    937780109 ns            1
nco_up<double>/1024                  14863 ns        14860 ns        46906
nco_up<double>/4096                  59030 ns        59022 ns        11853
nco_up<double>/32768                474611 ns       474511 ns         1471
nco_up<double>/262144              3831564 ns      3830538 ns          183
nco_up<double>/1024000            15085252 ns     15079233 ns           47
nco_up<double>/4096000            60517709 ns     60493935 ns           12
nco_up<double>/16000000          234850239 ns    234765540 ns            3
nco_up<double>/27000000          395563750 ns    395411762 ns            2
nco_up<double>/35000000          509798809 ns    509584368 ns            1
nco_up<double>/50000000          730523001 ns    730242498 ns            1
nco_up_complex<double>/1024          19304 ns        19299 ns        36612
nco_up_complex<double>/4096          75204 ns        75189 ns         9342
nco_up_complex<double>/32768        600686 ns       600575 ns         1171
nco_up_complex<double>/262144      4806897 ns      4805585 ns          145
nco_up_complex<double>/1024000    18744294 ns     18736998 ns           36
nco_up_complex<double>/4096000    74896809 ns     74870731 ns            9
nco_up_complex<double>/16000000  293500304 ns    293404252 ns            2
nco_up_complex<double>/27000000  496350451 ns    496176945 ns            2
nco_up_complex<double>/35000000  646216702 ns    645988919 ns            1
nco_up_complex<double>/50000000  922444997 ns    921699949 ns            1
```

## Analysis
I was not expecting those results. The performance improvements are incredible. We now fit within 1 second at 50M samples.


# Repeated calls III
## Description
There is one last calculation of `lookup_size_ / 4` that keeps being done. Let's optimize this one.

## Results
```
2021-02-21T18:37:07-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 2.05, 1.00, 0.70
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------------
Benchmark                                Time             CPU   Iterations
--------------------------------------------------------------------------
nco_up<float>/1024                   14800 ns        14797 ns        48085
nco_up<float>/4096                   58776 ns        58765 ns        11943
nco_up<float>/32768                 473316 ns       473220 ns         1485
nco_up<float>/262144               3816040 ns      3815225 ns          185
nco_up<float>/1024000             14834147 ns     14830026 ns           47
nco_up<float>/4096000             59211184 ns     59195080 ns           12
nco_up<float>/16000000           231102044 ns    231034873 ns            3
nco_up<float>/27000000           390813493 ns    390683319 ns            2
nco_up<float>/35000000           505171416 ns    505030030 ns            1
nco_up<float>/50000000           723502104 ns    723286571 ns            1
nco_up_complex<float>/1024           18337 ns        18333 ns        38185
nco_up_complex<float>/4096           73255 ns        73243 ns         9546
nco_up_complex<float>/32768         588534 ns       588428 ns         1190
nco_up_complex<float>/262144       4892695 ns      4891608 ns          148
nco_up_complex<float>/1024000     18495442 ns     18491089 ns           35
nco_up_complex<float>/4096000     76047299 ns     76029882 ns           10
nco_up_complex<float>/16000000   310817039 ns    310750056 ns            2
nco_up_complex<float>/27000000   534777385 ns    534652107 ns            1
nco_up_complex<float>/35000000   679420622 ns    679272214 ns            1
nco_up_complex<float>/50000000   924802076 ns    924578666 ns            1
nco_up<double>/1024                  14748 ns        14745 ns        47508
nco_up<double>/4096                  58820 ns        58811 ns        11872
nco_up<double>/32768                470610 ns       470525 ns         1487
nco_up<double>/262144              3809480 ns      3808569 ns          183
nco_up<double>/1024000            14907054 ns     14900983 ns           47
nco_up<double>/4096000            59533679 ns     59510791 ns           11
nco_up<double>/16000000          234088640 ns    233999837 ns            3
nco_up<double>/27000000          393578876 ns    393412955 ns            2
nco_up<double>/35000000          512920551 ns    512720631 ns            1
nco_up<double>/50000000          726265879 ns    725975982 ns            1
nco_up_complex<double>/1024          18599 ns        18596 ns        37636
nco_up_complex<double>/4096          74355 ns        74344 ns         9383
nco_up_complex<double>/32768        595537 ns       595428 ns         1180
nco_up_complex<double>/262144      4829946 ns      4828917 ns          146
nco_up_complex<double>/1024000    18649272 ns     18642893 ns           37
nco_up_complex<double>/4096000    74702167 ns     74677553 ns            9
nco_up_complex<double>/16000000  294119161 ns    294018703 ns            2
nco_up_complex<double>/27000000  508257689 ns    508122647 ns            1
nco_up_complex<double>/35000000  654964663 ns    654751960 ns            1
nco_up_complex<double>/50000000  913390325 ns    913075016 ns            1
```

## Analysis
The results are in the noise. There's no noticeable gain there, and any performance improvement might be thwarted by caching issues due to the extra variable. It felt like I had more performance by not using it, so I won't.


# New baseline
## Description
Since we are now able to process 1 second of samples at 50M within less than a second, let's add 100M.

## Results
```
2021-02-21T21:03:53-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.47, 0.52, 0.37
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
---------------------------------------------------------------------------
Benchmark                                 Time             CPU   Iterations
---------------------------------------------------------------------------
nco_up<float>/1024                    14636 ns        14633 ns        48051
nco_up<float>/4096                    59550 ns        59532 ns        12031
nco_up<float>/32768                  472651 ns       472520 ns         1472
nco_up<float>/262144                3775785 ns      3774730 ns          187
nco_up<float>/1024000              14656765 ns     14652381 ns           48
nco_up<float>/4096000              58541622 ns     58523704 ns           12
nco_up<float>/16000000            228830239 ns    228738617 ns            3
nco_up<float>/27000000            408256569 ns    408091836 ns            2
nco_up<float>/35000000            500392469 ns    500228412 ns            1
nco_up<float>/50000000            713077338 ns    712861969 ns            1
nco_up<float>/100000000          1428149607 ns   1427746504 ns            1
nco_up_complex<float>/1024            18556 ns        18553 ns        37716
nco_up_complex<float>/4096            74308 ns        74296 ns         9169
nco_up_complex<float>/32768          602067 ns       601926 ns         1185
nco_up_complex<float>/262144        4743294 ns      4742377 ns          148
nco_up_complex<float>/1024000      18677656 ns     18672945 ns           38
nco_up_complex<float>/4096000      74705460 ns     74687700 ns            9
nco_up_complex<float>/16000000    296206700 ns    296114010 ns            2
nco_up_complex<float>/27000000    504326596 ns    504166662 ns            1
nco_up_complex<float>/35000000    639335090 ns    639148399 ns            1
nco_up_complex<float>/50000000    909148315 ns    908927933 ns            1
nco_up_complex<float>/100000000  1830445125 ns   1829976650 ns            1
nco_up<double>/1024                   14848 ns        14845 ns        48113
nco_up<double>/4096                   59110 ns        59098 ns        11758
nco_up<double>/32768                 472469 ns       472373 ns         1493
nco_up<double>/262144               3755982 ns      3755110 ns          187
nco_up<double>/1024000             14654563 ns     14649286 ns           48
nco_up<double>/4096000             59155352 ns     59132421 ns           12
nco_up<double>/16000000           236008197 ns    235908440 ns            3
nco_up<double>/27000000           393862869 ns    393682413 ns            2
nco_up<double>/35000000           508731426 ns    508479907 ns            1
nco_up<double>/50000000           725744903 ns    725420962 ns            1
nco_up<double>/100000000         1450393643 ns   1449797550 ns            1
nco_up_complex<double>/1024           19027 ns        19019 ns        36531
nco_up_complex<double>/4096           75557 ns        75543 ns         9157
nco_up_complex<double>/32768         608434 ns       608312 ns         1155
nco_up_complex<double>/262144       4834451 ns      4833299 ns          146
nco_up_complex<double>/1024000     18854036 ns     18842467 ns           37
nco_up_complex<double>/4096000     75587836 ns     75560517 ns            9
nco_up_complex<double>/16000000   295939661 ns    295753078 ns            2
nco_up_complex<double>/27000000   503361781 ns    503160816 ns            1
nco_up_complex<double>/35000000   660002028 ns    659740720 ns            1
nco_up_complex<double>/50000000   941451655 ns    941024596 ns            1
nco_up_complex<double>/100000000 1857595264 ns   1856919853 ns            1
```

## Analysis
It seems our new maximum sample rate is 70M for `float`s and 69M for `double`s. The performance of `std::complex` is still much lower and I don't think at this point anyone seriously looking for speed should use them.


# `unsigned int` vs `std::size_t`
## Description
I use `std::size_t` out of habit, but what if `unsigned int` was faster for the loop counter?

## Results
```
2021-02-21T21:13:55-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.75, 0.82, 0.60
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
---------------------------------------------------------------------------
Benchmark                                 Time             CPU   Iterations
---------------------------------------------------------------------------
nco_up<float>/1024                    14811 ns        14809 ns        47163
nco_up<float>/4096                    59444 ns        59431 ns        11840
nco_up<float>/32768                  479202 ns       479118 ns         1473
nco_up<float>/262144                3814343 ns      3813470 ns          183
nco_up<float>/1024000              14945004 ns     14941314 ns           47
nco_up<float>/4096000              60297349 ns     60280864 ns           12
nco_up<float>/16000000            236201426 ns    236143607 ns            3
nco_up<float>/27000000            394599838 ns    394487423 ns            2
nco_up<float>/35000000            513414779 ns    513250036 ns            1
nco_up<float>/50000000            733914130 ns    733740159 ns            1
nco_up<float>/100000000          1461840260 ns   1461468641 ns            1
nco_up_complex<float>/1024            18703 ns        18700 ns        37480
nco_up_complex<float>/4096            74492 ns        74479 ns         9473
nco_up_complex<float>/32768          596960 ns       596854 ns         1187
nco_up_complex<float>/262144        4779337 ns      4778308 ns          148
nco_up_complex<float>/1024000      18569030 ns     18564974 ns           38
nco_up_complex<float>/4096000      74079759 ns     74062518 ns            9
nco_up_complex<float>/16000000    290563748 ns    290500728 ns            2
nco_up_complex<float>/27000000    490271084 ns    490145655 ns            2
nco_up_complex<float>/35000000    633833021 ns    633679867 ns            1
nco_up_complex<float>/50000000    906926067 ns    906746585 ns            1
nco_up_complex<float>/100000000  1817656630 ns   1817258149 ns            1
nco_up<double>/1024                   14899 ns        14897 ns        46859
nco_up<double>/4096                   59322 ns        59312 ns        11834
nco_up<double>/32768                 474918 ns       474833 ns         1473
nco_up<double>/262144               3804838 ns      3804036 ns          185
nco_up<double>/1024000             15197240 ns     15190940 ns           47
nco_up<double>/4096000             60924117 ns     60897074 ns           12
nco_up<double>/16000000           235550015 ns    235443659 ns            3
nco_up<double>/27000000           396615553 ns    396472744 ns            2
nco_up<double>/35000000           520682232 ns    520448792 ns            1
nco_up<double>/50000000           756480793 ns    756110995 ns            1
nco_up<double>/100000000         1467228179 ns   1466486820 ns            1
nco_up_complex<double>/1024           19924 ns        19920 ns        35789
nco_up_complex<double>/4096           79326 ns        79306 ns         8803
nco_up_complex<double>/32768         603807 ns       603675 ns         1180
nco_up_complex<double>/262144       5008128 ns      5006101 ns          100
nco_up_complex<double>/1024000     19242412 ns     19231552 ns           33
nco_up_complex<double>/4096000     79750381 ns     79713079 ns            9
nco_up_complex<double>/16000000   301658824 ns    301517126 ns            2
nco_up_complex<double>/27000000   510101382 ns    509849406 ns            1
nco_up_complex<double>/35000000   652933468 ns    652627687 ns            1
nco_up_complex<double>/50000000   937309509 ns    936906186 ns            1
nco_up_complex<double>/100000000 1860677938 ns   1859890466 ns            1
```

## Analysis
It seems like using `unsigned int` is a bit slower than using `std::size_t`. The difference is very small, probably it's just noise, I'm not sure why that is, probably related to some compiler optimizations, but I'll stick to `std::size_t` for now.


# Loop unrolling
## Description
It seems the compiler loop unrolling gives us some good performance, but maybe we can optimize by having more control over it. Let's start by unrolling in groups of 4.

## Results
```
2021-02-21T21:23:04-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.89, 0.83, 0.71
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
---------------------------------------------------------------------------
Benchmark                                 Time             CPU   Iterations
---------------------------------------------------------------------------
nco_up<float>/1024                    14541 ns        14537 ns        48702
nco_up<float>/4096                    58025 ns        58013 ns        12012
nco_up<float>/32768                  472641 ns       472527 ns         1490
nco_up<float>/262144                3762608 ns      3761546 ns          188
nco_up<float>/1024000              14668705 ns     14664093 ns           48
nco_up<float>/4096000              58133881 ns     58116421 ns           12
nco_up<float>/16000000            229431434 ns    229367144 ns            3
nco_up<float>/27000000            383650188 ns    383542131 ns            2
nco_up<float>/35000000            497794228 ns    497649395 ns            2
nco_up<float>/50000000            710526317 ns    710296526 ns            1
nco_up<float>/100000000          1454806897 ns   1448146673 ns            1
nco_up_complex<float>/1024            18552 ns        18343 ns        37567
nco_up_complex<float>/4096            73682 ns        72891 ns         9705
nco_up_complex<float>/32768          638359 ns       631155 ns         1137
nco_up_complex<float>/262144        4730642 ns      4672443 ns          150
nco_up_complex<float>/1024000      18375421 ns     18149443 ns           38
nco_up_complex<float>/4096000      72164104 ns     72142889 ns            9
nco_up_complex<float>/16000000    290166084 ns    290099026 ns            3
nco_up_complex<float>/27000000    482411732 ns    482289168 ns            2
nco_up_complex<float>/35000000    622500748 ns    622298384 ns            1
nco_up_complex<float>/50000000    882638960 ns    882432154 ns            1
nco_up_complex<float>/100000000  1834354459 ns   1812098337 ns            1
nco_up<double>/1024                   14718 ns        14667 ns        47999
nco_up<double>/4096                   57894 ns        57882 ns        12084
nco_up<double>/32768                 468311 ns       468225 ns         1484
nco_up<double>/262144               3737042 ns      3735980 ns          187
nco_up<double>/1024000             14626961 ns     14621023 ns           47
nco_up<double>/4096000             58283204 ns     58258984 ns           12
nco_up<double>/16000000           230236792 ns    230144511 ns            3
nco_up<double>/27000000           383997048 ns    383839418 ns            2
nco_up<double>/35000000           500400564 ns    500192662 ns            2
nco_up<double>/50000000           714684091 ns    714372889 ns            1
nco_up<double>/100000000         1431612977 ns   1431033017 ns            1
nco_up_complex<double>/1024           18094 ns        18090 ns        38874
nco_up_complex<double>/4096           72398 ns        72366 ns         9677
nco_up_complex<double>/32768         600743 ns       600619 ns         1184
nco_up_complex<double>/262144       4727451 ns      4725244 ns          148
nco_up_complex<double>/1024000     18362827 ns     18356163 ns           38
nco_up_complex<double>/4096000     73911310 ns     73882408 ns            9
nco_up_complex<double>/16000000   289074012 ns    288963422 ns            2
nco_up_complex<double>/27000000   484400275 ns    484232572 ns            2
nco_up_complex<double>/35000000   640009413 ns    639780216 ns            1
nco_up_complex<double>/50000000   900586365 ns    900280423 ns            1
nco_up_complex<double>/100000000 1786624541 ns   1785862146 ns            1
```

## Analysis
There are some improvements, some slow downs. It's hard to tell.


# Loop unrolling II
## Description
Let's try a more aggressive approach with 16 for the unrolling factor. This should give us a better idea if there are gains or not.

## Results
See `2021-02-21 nco no-unrolling.txt` and `2021-02-21 nco 16-unrolling.txt` for results.

## Analysis
There are definitely performance gains to be had when unrolling loops manually. I'm just not convinced there will be gains on all systems. More testing is required, but so far, I'll keep it.


# Recap
## Description
We started the day with a rather slow but acceptable performance. Let's see how we did.

## Results
### Baseline
```
2021-02-21T09:55:15-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.36, 0.40, 0.35
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
--------------------------------------------------------------------
Benchmark                          Time             CPU   Iterations
--------------------------------------------------------------------
nco_up<float>/1024             28766 ns        28761 ns        24339
nco_up<float>/4096            116299 ns       116278 ns         6078
nco_up<float>/32768           920083 ns       919917 ns          758
nco_up<float>/262144         7396784 ns      7395356 ns           93
nco_up<float>/1024000       28801596 ns     28795022 ns           24
nco_up<float>/4096000      115506281 ns    115479732 ns            6
nco_up<float>/16000000     449877325 ns    449767884 ns            2
nco_up<float>/27000000     758913351 ns    758721863 ns            1
nco_up<float>/35000000     985470723 ns    985235268 ns            1
nco_up<float>/50000000    1427462288 ns   1427158026 ns            1
nco_up<double>/1024            37318 ns        37311 ns        18675
nco_up<double>/4096           149208 ns       149180 ns         4696
nco_up<double>/32768         1201791 ns      1201551 ns          586
nco_up<double>/262144        9588762 ns      9586893 ns           73
nco_up<double>/1024000      37418452 ns     37410087 ns           19
nco_up<double>/4096000     149259709 ns    149225540 ns            5
nco_up<double>/16000000    584357062 ns    584199505 ns            1
nco_up<double>/27000000    984824927 ns    984587102 ns            1
nco_up<double>/35000000   1279257848 ns   1278955889 ns            1
nco_up<double>/50000000   1824613267 ns   1824184416 ns            1
```

### End results
```
2021-02-21T21:51:34-05:00
Running bin/test
Run on (16 X 3700 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x8)
  L1 Instruction 64 KiB (x8)
  L2 Unified 512 KiB (x8)
  L3 Unified 8192 KiB (x2)
Load Average: 0.36, 0.48, 0.61
***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.
---------------------------------------------------------------------------
Benchmark                                 Time             CPU   Iterations
---------------------------------------------------------------------------
nco_up<float>/1024                    14504 ns        14501 ns        49018
nco_up<float>/4096                    57750 ns        57738 ns        12119
nco_up<float>/32768                  466475 ns       466370 ns         1511
nco_up<float>/262144                3743214 ns      3742307 ns          189
nco_up<float>/1024000              14520023 ns     14515316 ns           49
nco_up<float>/4096000              58022148 ns     58002763 ns           12
nco_up<float>/16000000            226544296 ns    226466342 ns            3
nco_up<float>/27000000            379751770 ns    379650286 ns            2
nco_up<float>/35000000            494707046 ns    494572365 ns            2
nco_up<float>/50000000            709128497 ns    708906347 ns            1
nco_up<double>/1024                   14476 ns        14474 ns        47398
nco_up<double>/4096                   57971 ns        57959 ns        12040
nco_up<double>/32768                 468287 ns       468215 ns         1490
nco_up<double>/262144               3766341 ns      3765483 ns          185
nco_up<double>/1024000             14715618 ns     14710274 ns           47
nco_up<double>/4096000             58735110 ns     58713059 ns           12
nco_up<double>/16000000           227320013 ns    227240890 ns            3
nco_up<double>/27000000           386733876 ns    386596237 ns            2
nco_up<double>/35000000           500792824 ns    500616638 ns            1
nco_up<double>/50000000           717892630 ns    717616755 ns            1
```

## Analysis
We have more than cut in half the time required to process 50M samples, bringing us down to below 1 second, thereby making it viable to use directly at that sampling rate. Of course, there might not be much more processing time left for the rest of the DSP, but using an NCO at such high sampling rates is also not the best decision.

Overall, the new code runs in about 50.2% of the timing of the original code. Impressive what a few changes that seem minor can do.

The biggest two impacts on performance were: inlining functions to remove calls, which brought our timing down to 77.5% of the original, and removing repeated function calls by replacing them with constant variables, which brought our timing down to 50.6% of the original. To reduce the gap between `float` and `double`, the lookup table really helped to stabilize the time taken. As it turns out, `std::cos` and `std::sin` are much slower when run with a higher precision. When it comes to `std::complex`, the biggest impact was the removal of the call to a constructor when building the phasor. This alone reduced the timing to 71.0% of the original for `std::complex<float>` and to 89.0% of the original for `std::complex<double>`.
